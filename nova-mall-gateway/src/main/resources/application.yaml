server:
  port: 8092

spring:
  application:
    name: demo-gateway
  data:
    redis:
      host: localhost
      port: 6379
  cloud:
    gateway:
      httpclient:
        connect-timeout: 3000
        response-timeout: 5000ms
      auth:
        enabled: true
        secret: change-me-please-change-me-please-32
        whitelist:
          - /user/doc.html
          - /user/v3/api-docs
          - /user/swagger-ui
          - /order/doc.html
          - /order/v3/api-docs
          - /order/swagger-ui
          - /product/doc.html
          - /product/v3/api-docs
          - /product/swagger-ui
          - /cart/doc.html
          - /cart/v3/api-docs
          - /cart/swagger-ui
          - /stock/doc.html
          - /stock/v3/api-docs
          - /stock/swagger-ui
          - /actuator
          - /fallback
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: false
      routes:
        - id: user-service
          uri: http://localhost:8083
          predicates:
            - Path=/user/**,/user/doc.html,/user/v3/api-docs/**,/user/swagger-ui.html,/user/swagger-ui/**,/user/webjars/**
          filters:
            - StripPrefix=1
            - name: Retry
              args:
                retries: 2
                statuses:
                  - BAD_GATEWAY
                  - INTERNAL_SERVER_ERROR
                  - SERVICE_UNAVAILABLE
                  - GATEWAY_TIMEOUT
                methods:
                  - GET
            - name: CircuitBreaker
              args:
                name: userCircuitBreaker
                fallbackUri: forward:/fallback/user
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 30
                redis-rate-limiter.burstCapacity: 60
        - id: order-service
          uri: http://localhost:8084
          predicates:
            - Path=/order/**,/order/doc.html,/order/v3/api-docs/**,/order/swagger-ui.html,/order/swagger-ui/**,/order/webjars/**
          filters:
            - StripPrefix=0
            - name: Retry
              args:
                retries: 2
                statuses:
                  - BAD_GATEWAY
                  - INTERNAL_SERVER_ERROR
                  - SERVICE_UNAVAILABLE
                  - GATEWAY_TIMEOUT
                methods:
                  - GET
            - name: CircuitBreaker
              args:
                name: orderCircuitBreaker
                fallbackUri: forward:/fallback/order
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 20
                redis-rate-limiter.burstCapacity: 40
        - id: product-service
          uri: http://localhost:8085
          predicates:
            - Path=/product/**,/product/doc.html,/product/v3/api-docs/**,/product/swagger-ui.html,/product/swagger-ui/**,/product/webjars/**
          filters:
            - StripPrefix=1
            - name: Retry
              args:
                retries: 2
                statuses:
                  - BAD_GATEWAY
                  - INTERNAL_SERVER_ERROR
                  - SERVICE_UNAVAILABLE
                  - GATEWAY_TIMEOUT
                methods:
                  - GET
            - name: CircuitBreaker
              args:
                name: productCircuitBreaker
                fallbackUri: forward:/fallback/product
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 30
                redis-rate-limiter.burstCapacity: 60
        - id: cart-service
          uri: http://localhost:8086
          predicates:
            - Path=/cart/**,/cart/doc.html,/cart/v3/api-docs/**,/cart/swagger-ui.html,/cart/swagger-ui/**,/cart/webjars/**
          filters:
            - StripPrefix=1
            - name: Retry
              args:
                retries: 2
                statuses:
                  - BAD_GATEWAY
                  - INTERNAL_SERVER_ERROR
                  - SERVICE_UNAVAILABLE
                  - GATEWAY_TIMEOUT
                methods:
                  - GET
            - name: CircuitBreaker
              args:
                name: cartCircuitBreaker
                fallbackUri: forward:/fallback/cart
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 30
                redis-rate-limiter.burstCapacity: 60
        - id: stock-service
          uri: http://localhost:8087
          predicates:
            - Path=/stock/**,/stock/doc.html,/stock/v3/api-docs/**,/stock/swagger-ui.html,/stock/swagger-ui/**,/stock/webjars/**
          filters:
            - StripPrefix=0
            - name: Retry
              args:
                retries: 2
                statuses:
                  - BAD_GATEWAY
                  - INTERNAL_SERVER_ERROR
                  - SERVICE_UNAVAILABLE
                  - GATEWAY_TIMEOUT
                methods:
                  - GET
            - name: CircuitBreaker
              args:
                name: stockCircuitBreaker
                fallbackUri: forward:/fallback/stock
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 30
                redis-rate-limiter.burstCapacity: 60
      default-filters:
        - AddResponseHeader=X-Gateway, demo-gateway
      local-rate-limit:
        enabled: false
        defaults:
          replenish-rate: 50
          burst-capacity: 100
        routes:
          - id: user-limit
            match-prefix: /user/
            replenish-rate: 30
            burst-capacity: 60
          - id: order-limit
            match-prefix: /order/
            replenish-rate: 20
            burst-capacity: 40
  main:
    web-application-type: reactive

management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: never

